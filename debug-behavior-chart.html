<!DOCTYPE html>
<html>
<head>
    <title>Debug Behavior Chart</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #222; color: white; }
        .chart { margin: 20px 0; padding: 15px; background: rgba(0,170,255,0.1); border-radius: 5px; }
        .chart h4 { color: #00aaff; }
        canvas { border: 1px solid #444; background: #333; }
        .debug-info { background: #111; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ðŸ§  Behavior Chart Debug Test</h1>
    
    <div class="debug-info" id="debug-output">
        <strong>Debug Output:</strong><br>
        <div id="debug-content">Loading...</div>
    </div>
    
    <div id="behavior-analysis-charts">
        <!-- Charts will be rendered here -->
    </div>

    <script src="analyst-insights.js"></script>
    <script>
        // Debug logging function
        function debugLog(message) {
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
        }

        // Create analyst insights instance
        debugLog('Creating AnalystInsights instance...');
        const insights = new AnalystInsights();
        
        // Force dashboard to be visible for testing
        if (insights.dashboard) {
            insights.dashboard.style.display = 'block';
            debugLog('Dashboard set to visible');
        }

        // Test 1: Track some behaviors
        debugLog('Test 1: Tracking first set of behaviors...');
        const behaviors1 = ['Extended tactical engagement', 'High-precision targeting'];
        const battleResult1 = {
            duration: 67.2,
            redTeamStats: { accuracy: 0.8 },
            blueTeamStats: { accuracy: 0.6 }
        };
        
        insights.trackEmergentBehaviors(behaviors1, battleResult1);
        debugLog(`Behaviors tracked. History length: ${insights.insightHistory.emergent_behaviors.length}`);
        debugLog(`First entry behaviors: ${JSON.stringify(insights.insightHistory.emergent_behaviors[0].behaviors)}`);

        // Test 2: Track more behaviors
        debugLog('Test 2: Tracking second set of behaviors...');
        const behaviors2 = ['Superior tactical positioning'];
        insights.trackEmergentBehaviors(behaviors2, battleResult1);
        debugLog(`Second tracking done. History length: ${insights.insightHistory.emergent_behaviors.length}`);

        // Test 3: Track empty behaviors to see what happens
        debugLog('Test 3: Tracking empty behaviors...');
        insights.trackEmergentBehaviors([], battleResult1);
        debugLog(`Empty behaviors tracked. History length: ${insights.insightHistory.emergent_behaviors.length}`);

        // Test 4: Manually check chart data
        debugLog('Test 4: Checking chart data mapping...');
        const recentBehaviors = insights.insightHistory.emergent_behaviors.slice(-15);
        const behaviorCounts = recentBehaviors.map(b => b.behaviors.length);
        debugLog(`Recent behaviors count: ${recentBehaviors.length}`);
        debugLog(`Behavior counts: [${behaviorCounts.join(', ')}]`);

        // Test 5: Check if chart container exists
        debugLog('Test 5: Checking chart container...');
        const chartContainer = document.getElementById('behavior-analysis-charts');
        debugLog(`Chart container found: ${!!chartContainer}`);
        
        if (chartContainer) {
            debugLog(`Chart container children: ${chartContainer.children.length}`);
            for (let i = 0; i < chartContainer.children.length; i++) {
                const child = chartContainer.children[i];
                debugLog(`Child ${i}: ${child.tagName} id="${child.id}" class="${child.className}"`);
            }
        }

        // Test 6: Force chart update
        debugLog('Test 6: Force updating behavior charts...');
        insights.updateBehaviorCharts();
        
        // Check again after forced update
        setTimeout(() => {
            debugLog('Post-update check:');
            const updatedContainer = document.getElementById('behavior-analysis-charts');
            if (updatedContainer) {
                debugLog(`Updated container children: ${updatedContainer.children.length}`);
                for (let i = 0; i < updatedContainer.children.length; i++) {
                    const child = updatedContainer.children[i];
                    debugLog(`Updated child ${i}: ${child.tagName} id="${child.id}"`);
                    if (child.tagName === 'DIV' && child.className === 'chart') {
                        debugLog(`Chart content: ${child.innerHTML.substring(0, 200)}...`);
                    }
                }
            }
            
            // Test the line chart drawing function directly
            debugLog('Test 7: Testing chart rendering directly...');
            const canvas = document.getElementById('behavior-frequency-canvas');
            if (canvas) {
                debugLog(`Canvas found: ${canvas.width}x${canvas.height}`);
                const ctx = canvas.getContext('2d');
                debugLog(`Canvas context: ${!!ctx}`);
            } else {
                debugLog('Canvas not found!');
            }
        }, 100);
    </script>
</body>
</html>
