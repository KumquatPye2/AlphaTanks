<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolution Tracking Charts Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            margin: 20px;
        }
        .test-panel {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0080ff;
        }
        .status {
            background: rgba(0,255,136,0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔬 Evolution Tracking Charts Test</h1>
    
    <div class="test-panel">
        <h2>Test Controls</h2>
        <button class="btn" onclick="openDashboard()">📊 Open Dashboard</button>
        <button class="btn" onclick="addTestData()">🧬 Add Test Data</button>
        <button class="btn" onclick="simulateEvolution()">⚡ Simulate Evolution</button>
        <button class="btn" onclick="testReset()">🔄 Test Reset</button>
        <button class="btn" onclick="checkCharts()">📈 Check Charts</button>
        
        <div id="status" class="status">
            Ready to test evolution tracking charts...
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="refactored/common/utils.js"></script>
    <script src="core/data-collector.js"></script>
    <script src="core/researcher-insights.js"></script>
    <script src="core/dashboard-ui.js"></script>

    <script>
        let researcherInsights;
        
        // Initialize the system
        function init() {
            try {
                researcherInsights = new ResearcherInsights();
                window.researcherInsights = researcherInsights;
                updateStatus('✅ Researcher Insights initialized successfully');
            } catch (error) {
                updateStatus('❌ Failed to initialize: ' + error.message);
            }
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
            console.log(message);
        }
        
        function openDashboard() {
            if (!researcherInsights) {
                updateStatus('❌ Researcher Insights not initialized');
                return;
            }
            
            try {
                researcherInsights.show();
                updateStatus('✅ Dashboard opened - check for Evolution Tracking panel with charts');
            } catch (error) {
                updateStatus('❌ Failed to open dashboard: ' + error.message);
            }
        }
        
        function addTestData() {
            if (!researcherInsights) {
                updateStatus('❌ Researcher Insights not initialized');
                return;
            }
            
            try {
                const dataCollector = researcherInsights.dataCollector;
                
                // Add some test generation data
                for (let gen = 1; gen <= 5; gen++) {
                    const eventData = {
                        topFitness: 0.5 + gen * 0.05,
                        averageFitness: 0.4 + gen * 0.03,
                        totalExperiments: gen * 10
                    };
                    
                    dataCollector.trackGenerationComplete(gen, eventData);
                }
                
                // Add some test metrics
                dataCollector.metrics.mutations = 25;
                dataCollector.metrics.crossovers = 15;
                dataCollector.metrics.tournaments = 30;
                dataCollector.metrics.redQueenAdaptations = 8;
                
                updateStatus('✅ Test data added - 5 generations with increasing fitness');
            } catch (error) {
                updateStatus('❌ Failed to add test data: ' + error.message);
            }
        }
        
        function simulateEvolution() {
            if (!researcherInsights) {
                updateStatus('❌ Researcher Insights not initialized');
                return;
            }
            
            try {
                const dataCollector = researcherInsights.dataCollector;
                
                // Simulate 10 generations of evolution
                for (let gen = 6; gen <= 15; gen++) {
                    // Random fitness values that show some evolution
                    const redFitness = 0.3 + Math.random() * 0.5 + gen * 0.02;
                    const blueFitness = 0.3 + Math.random() * 0.5 + gen * 0.015;
                    
                    const eventData = {
                        topFitness: Math.max(redFitness, blueFitness),
                        averageFitness: (redFitness + blueFitness) / 2,
                        totalExperiments: gen * 10
                    };
                    
                    // Add some generation data with team fitness
                    dataCollector.trackGenerationComplete(gen, eventData);
                    
                    // Update the saved fitness manually to test charts
                    const lastGenData = dataCollector.generationData[dataCollector.generationData.length - 1];
                    if (lastGenData) {
                        lastGenData.savedFitness = {
                            red: redFitness,
                            blue: blueFitness
                        };
                    }
                    
                    // Add some random operations
                    dataCollector.metrics.mutations += Math.floor(Math.random() * 5) + 1;
                    dataCollector.metrics.crossovers += Math.floor(Math.random() * 3) + 1;
                    dataCollector.metrics.tournaments += Math.floor(Math.random() * 4) + 2;
                    if (Math.random() > 0.7) {
                        dataCollector.metrics.redQueenAdaptations += 1;
                    }
                }
                
                updateStatus('✅ Simulated 10 generations of evolution with varying fitness');
            } catch (error) {
                updateStatus('❌ Failed to simulate evolution: ' + error.message);
            }
        }
        
        function testReset() {
            if (!researcherInsights) {
                updateStatus('❌ Researcher Insights not initialized');
                return;
            }
            
            try {
                // Add some data first
                addTestData();
                
                const beforeReset = researcherInsights.dataCollector.exportData();
                updateStatus(`Before reset: ${beforeReset.generationData.length} generations, ${beforeReset.metrics.mutations} mutations`);
                
                // Wait a moment then reset
                setTimeout(() => {
                    researcherInsights.reset();
                    
                    const afterReset = researcherInsights.dataCollector.exportData();
                    updateStatus(`✅ Reset complete! After reset: ${afterReset.generationData.length} generations, ${afterReset.metrics.mutations} mutations`);
                }, 1000);
                
            } catch (error) {
                updateStatus('❌ Failed to test reset: ' + error.message);
            }
        }
        
        function checkCharts() {
            if (!researcherInsights) {
                updateStatus('❌ Researcher Insights not initialized');
                return;
            }
            
            try {
                const dashboardUI = researcherInsights.dashboardUI;
                const data = researcherInsights.dataCollector.exportData();
                
                let status = '📊 Chart Status:<br>';
                status += `• Generation Data: ${data.generationData.length} entries<br>`;
                status += `• Mutations: ${data.metrics.mutations}<br>`;
                status += `• Crossovers: ${data.metrics.crossovers}<br>`;
                status += `• Tournaments: ${data.metrics.tournaments}<br>`;
                status += `• Red Queen Adaptations: ${data.metrics.redQueenAdaptations}<br>`;
                
                // Check if charts exist
                const fitnessChart = dashboardUI.chartManager.getChart('fitness-evolution-chart');
                
                status += `• Fitness Chart: ${fitnessChart ? '✅ Loaded' : '❌ Missing'}<br>`;
                
                updateStatus(status);
            } catch (error) {
                updateStatus('❌ Failed to check charts: ' + error.message);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
