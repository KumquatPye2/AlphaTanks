<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Obstacle System Demo - AlphaTanks</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #00aaff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
            margin-bottom: 30px;
        }
        
        .demo-section {
            background: rgba(0, 170, 255, 0.1);
            border: 2px solid #00aaff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background: #00aaff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #0088cc;
            box-shadow: 0 0 10px #00aaff;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #gameCanvas {
            border: 3px solid #00aaff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
            display: block;
            margin: 0 auto;
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-box {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00aaff;
            border-radius: 5px;
            padding: 15px;
        }
        
        .info-box h3 {
            color: #00ff88;
            margin-top: 0;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(0, 170, 255, 0.2);
        }
        
        .feature-list li:before {
            content: "‚úÖ ";
            color: #00ff88;
        }
        
        .metrics {
            font-size: 12px;
            line-height: 1.4;
        }
        
        .debug-toggle {
            background: #ff6600;
        }
        
        .debug-toggle:hover {
            background: #ff8833;
        }
        
        .status {
            text-align: center;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .status.active {
            color: #00ff88;
        }
        
        .status.inactive {
            color: #ff6666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöß Enhanced Obstacle System Demo</h1>
        
        <div class="demo-section">
            <h2>üéÆ Interactive Demo</h2>
            <div class="controls">
                <button onclick="startDemo()">‚ñ∂Ô∏è Start Enhanced Battle</button>
                <button onclick="pauseDemo()">‚è∏Ô∏è Pause</button>
                <button onclick="resetDemo()">üîÑ Reset</button>
                <button onclick="toggleDebugMode()" class="debug-toggle">üîß Toggle Debug Mode</button>
                <button onclick="togglePathfindingViz()" class="debug-toggle">üó∫Ô∏è Show Pathfinding Grid</button>
                <button onclick="toggleTankAIDebug()" class="debug-toggle">ü§ñ Tank AI Debug</button>
            </div>
            
            <div id="status" class="status inactive">
                System Status: Enhanced Obstacle System Ready
            </div>
            
            <canvas id="gameCanvas" width="800" height="500"></canvas>
        </div>
        
        <div class="info-panel">
            <div class="info-box">
                <h3>üöÄ Enhanced Features</h3>
                <ul class="feature-list">
                    <li>A* Pathfinding Algorithm</li>
                    <li>Smart Obstacle Avoidance</li>
                    <li>Strategic Obstacle Placement</li>
                    <li>Path Optimization</li>
                    <li>Stuck Detection & Recovery</li>
                    <li>Multiple Avoidance Strategies</li>
                    <li>Visual Debugging Tools</li>
                    <li>Performance Optimization</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h3>üéØ Problem Solutions</h3>
                <ul class="feature-list">
                    <li>No More Tank Stuck Issues</li>
                    <li>Intelligent Route Planning</li>
                    <li>Smooth Movement Around Obstacles</li>
                    <li>Strategic Map Design</li>
                    <li>Predictive Collision Detection</li>
                    <li>Dynamic Path Recalculation</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h3>üìä Live Metrics</h3>
                <div id="metrics" class="metrics">
                    <div>Tanks with Active Paths: <span id="tanksWithPaths">0</span></div>
                    <div>Average Path Length: <span id="avgPathLength">0</span></div>
                    <div>Stuck Tanks: <span id="stuckTanks">0</span></div>
                    <div>Pathfinding Calls/sec: <span id="pathfindingRate">0</span></div>
                    <div>Collision Avoidance Events: <span id="avoidanceEvents">0</span></div>
                </div>
            </div>
            
            <div class="info-box">
                <h3>üîß Debug Controls</h3>
                <div>
                    <p><strong>Debug Mode:</strong> Shows obstacle types and tank states</p>
                    <p><strong>Pathfinding Grid:</strong> Visualizes walkable/blocked areas</p>
                    <p><strong>Tank AI Debug:</strong> Shows paths and waypoints</p>
                    <p><strong>Click Canvas:</strong> Set custom target for nearest tank</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Core AlphaTanks Scripts -->
    <script src="tank-ai.js"></script>
    <script src="game-engine.js"></script>
    <script src="enhanced-obstacle-system.js"></script>
    <script src="enhanced-tank-ai.js"></script>

    <script>
        let game = null;
        let isRunning = false;
        let metricsInterval = null;
        let pathfindingCallCount = 0;
        let avoidanceEventCount = 0;

        function initializeDemo() {
            const canvas = document.getElementById('gameCanvas');
            
            // Create game engine
            game = new GameEngine('gameCanvas');
            
            // Initialize with fewer tanks for better demonstration
            game.initializeBattle(3, 3);
            
            // Upgrade to enhanced obstacle system
            ObstacleSystemIntegrator.upgradeGameEngine(game);
            
            // Set up click handler for manual target setting
            canvas.addEventListener('click', handleCanvasClick);
            
            // Start metrics monitoring
            startMetricsMonitoring();
            
            updateStatus('Enhanced Obstacle System Initialized', 'active');
            console.log('üéÆ Demo initialized with enhanced obstacle system');
        }

        function startDemo() {
            if (!game) {
                initializeDemo();
            }
            
            game.start();
            isRunning = true;
            updateStatus('Battle Running with Enhanced AI', 'active');
        }

        function pauseDemo() {
            if (game) {
                game.pause();
                isRunning = false;
                updateStatus('Battle Paused', 'inactive');
            }
        }

        function resetDemo() {
            if (game) {
                game.reset();
                // Re-apply enhancements after reset
                ObstacleSystemIntegrator.upgradeGameEngine(game);
                isRunning = false;
                pathfindingCallCount = 0;
                avoidanceEventCount = 0;
                updateStatus('Battle Reset - Enhanced System Ready', 'active');
            }
        }

        function toggleDebugMode() {
            window.DEBUG = !window.DEBUG;
            updateStatus(`Debug Mode: ${window.DEBUG ? 'ON' : 'OFF'}`, 'active');
        }

        function togglePathfindingViz() {
            window.DEBUG_PATHFINDING = !window.DEBUG_PATHFINDING;
            updateStatus(`Pathfinding Visualization: ${window.DEBUG_PATHFINDING ? 'ON' : 'OFF'}`, 'active');
        }

        function toggleTankAIDebug() {
            window.DEBUG_TANK_AI = !window.DEBUG_TANK_AI;
            updateStatus(`Tank AI Debug: ${window.DEBUG_TANK_AI ? 'ON' : 'OFF'}`, 'active');
        }

        function handleCanvasClick(event) {
            if (!game || !isRunning) return;
            
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Find nearest tank and set its target
            let nearestTank = null;
            let nearestDistance = Infinity;
            
            game.tanks.forEach(tank => {
                if (!tank.isAlive) return;
                
                const distance = Math.sqrt(
                    Math.pow(tank.x - x, 2) + Math.pow(tank.y - y, 2)
                );
                
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestTank = tank;
                }
            });
            
            if (nearestTank) {
                nearestTank.targetX = x;
                nearestTank.targetY = y;
                nearestTank.state = 'manual_target';
                
                // Force pathfinding update
                if (nearestTank.enhancedAI) {
                    nearestTank.enhancedAI.currentPath = null;
                    nearestTank.enhancedAI.pathUpdateTimer = 999;
                }
                
                updateStatus(`Target set for ${nearestTank.team} tank at (${x}, ${y})`, 'active');
            }
        }

        function startMetricsMonitoring() {
            if (metricsInterval) {
                clearInterval(metricsInterval);
            }
            
            metricsInterval = setInterval(updateMetrics, 1000);
        }

        function updateMetrics() {
            if (!game || !game.tanks) return;
            
            const aliveTanks = game.tanks.filter(tank => tank.isAlive);
            let tanksWithPaths = 0;
            let totalPathLength = 0;
            let stuckTanks = 0;
            
            aliveTanks.forEach(tank => {
                if (tank.enhancedAI) {
                    const metrics = tank.enhancedAI.getPerformanceMetrics();
                    if (metrics.hasPath) {
                        tanksWithPaths++;
                        totalPathLength += metrics.pathLength;
                    }
                    if (metrics.isStuck) {
                        stuckTanks++;
                    }
                }
            });
            
            const avgPathLength = tanksWithPaths > 0 ? (totalPathLength / tanksWithPaths).toFixed(1) : 0;
            
            document.getElementById('tanksWithPaths').textContent = `${tanksWithPaths}/${aliveTanks.length}`;
            document.getElementById('avgPathLength').textContent = avgPathLength;
            document.getElementById('stuckTanks').textContent = stuckTanks;
            document.getElementById('pathfindingRate').textContent = pathfindingCallCount;
            document.getElementById('avoidanceEvents').textContent = avoidanceEventCount;
            
            // Reset counters
            pathfindingCallCount = 0;
            avoidanceEventCount = 0;
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = `System Status: ${message}`;
            statusElement.className = `status ${type}`;
        }

        // Override pathfinding to count calls
        const originalFindPath = EnhancedObstacleSystem.prototype.findPath;
        EnhancedObstacleSystem.prototype.findPath = function(...args) {
            pathfindingCallCount++;
            return originalFindPath.apply(this, args);
        };

        // Override avoidance to count events
        const originalCalculateAvoidanceVector = EnhancedObstacleSystem.prototype.calculateAvoidanceVector;
        EnhancedObstacleSystem.prototype.calculateAvoidanceVector = function(...args) {
            avoidanceEventCount++;
            return originalCalculateAvoidanceVector.apply(this, args);
        };

        // Initialize demo when page loads
        window.addEventListener('load', () => {
            console.log('üöß Enhanced Obstacle System Demo Loaded');
            console.log('üìã Available Commands:');
            console.log('  - Click canvas to set tank targets');
            console.log('  - Use debug toggles to see system internals');
            console.log('  - Monitor metrics for performance insights');
            
            // Auto-initialize demo
            setTimeout(initializeDemo, 500);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (metricsInterval) {
                clearInterval(metricsInterval);
            }
        });
    </script>
</body>
</html>
